#!/bin/bash

file_user_config_c=`mktemp npXXXXXX`
file_user_config_h=`mktemp npXXXXXX`

# header for user_config.c
echo '
/* Autogenerated File */
#define OUTPUT 0
#define INPUT 1
#define LOW 0
#define HIGH 1

/* fix for MCU missing PORTA (http://bugs.ethersex.de/view.php?id=166) */
#ifdef PORTA
#define PORT_CORR 0
#else
#define PORT_CORR 1
#endif
' >> $file_user_config_c

# header for user_config.h
echo -e "/* Autogenerated File*/\n#ifndef NAMEDPIN_CONF\n#define NAMEDPIN_CONF\n" >> $file_user_config_h

# content for both
consts=""
eeprom=""
unique=""
count=0

while read line; do
  port=0x`echo $line | awk '{print $1}' | cut -c 2 | tr 'ABCDEFGHJKLabcdefghjkl' '0123456789A0123456789A'`
  pin=`echo $line | awk '{print $1}' | cut -c 3`
  input=`echo $line | awk '{print $2}'`
  active_high=`echo $line | awk '{print $3}'`
  name=`echo $line | awk '{print $4}'`
  echo "#define ${name}_PORT `echo $line | awk '{print $1}' | cut -c 2 | tr 'abcdefghjkl' 'ABCDEFGHJKL'`" >> $file_user_config_h
  echo "#define ${name}_PIN $pin" >> $file_user_config_h

  textid="$RANDOM"
  while [ `echo "$unique" | grep -q "$textid"` ]
  do
    textid="$RANDOM"
  done
  unique="$unique $textid"

  consts="$consts""const char named_pin_text$textid[] PROGMEM = \"$name\";\n"
  eeprom="$eeprom\t{\t$port - PORT_CORR,\t$pin,\t$input,\t$active_high,\tnamed_pin_text$textid }, \t/* $name\t*/ \n"
  ((count++))
done << EOF
`grep -v -e ^# < "$1"`
EOF

# footer for user_config.c
echo -e "$consts" >> $file_user_config_c
echo "const struct PinConfiguration portio_pincfg[] PROGMEM = {" >> $file_user_config_c
echo -e "    /*  port\tpin\tinput\treverse? */" >> $file_user_config_c
echo -e "$eeprom" >> $file_user_config_c
echo "};" >> $file_user_config_c

# footer for user_config.h
echo "#define NAMEDPIN_COUNT $count" >> $file_user_config_h
echo "#endif" >> $file_user_config_h

# temp to real files
mv $file_user_config_c core/portio/user_config.c
mv $file_user_config_h core/portio/user_config.h
